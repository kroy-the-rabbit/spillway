{{- if .Values.admissionPolicy.enabled }}
# ValidatingAdmissionPolicy â€” enforces valid spillway.kroy.io/default-replicate
# label values on Namespace objects.  Requires Kubernetes 1.30+.
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: {{ include "spillway.fullname" . }}-namespace-label
  labels:
    {{- include "spillway.labels" . | nindent 4 }}
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups:   [""]
        apiVersions: ["v1"]
        operations:  ["CREATE", "UPDATE"]
        resources:   ["namespaces"]
  variables:
    - name: labelValue
      expression: >
        has(object.metadata.labels) &&
        'spillway.kroy.io/default-replicate' in object.metadata.labels
          ? object.metadata.labels['spillway.kroy.io/default-replicate']
          : ''
    - name: hasLabel
      expression: >
        has(object.metadata.labels) &&
        'spillway.kroy.io/default-replicate' in object.metadata.labels
    - name: tokens
      expression: >
        variables.hasLabel
          ? variables.labelValue.split(',').filter(t, t.trim() != '')
          : []
    - name: allTokensNonEmpty
      expression: >
        variables.tokens.all(t, t.trim() != '')
  validations:
    - expression: >
        !variables.hasLabel || (variables.tokens.size() > 0 && variables.allTokensNonEmpty)
      message: >
        spillway.kroy.io/default-replicate must be a non-empty comma-separated
        list of namespace selectors (e.g. "all", "team-*", "payments,prod").
      reason: Invalid
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: {{ include "spillway.fullname" . }}-namespace-label
  labels:
    {{- include "spillway.labels" . | nindent 4 }}
spec:
  policyName: {{ include "spillway.fullname" . }}-namespace-label
  validationActions:
    {{- toYaml .Values.admissionPolicy.validationActions | nindent 4 }}
{{- end }}
