name: CI

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify gofmt
        run: |
          test -z "$(gofmt -l $(go list -f '{{.Dir}}' ./...))"

      - name: Run unit and smoke tests
        run: go test ./...

      - name: Run race tests
        run: go test -race ./...

      - name: Run go vet
        run: go vet ./...

      - name: Build binary
        run: |
          go build -ldflags="-X main.version=ci" -o /tmp/spillway ./cmd/spillway

  helm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1

      - name: Helm lint
        run: helm lint charts/spillway

      - name: Helm smoke render
        run: |
          helm template spillway charts/spillway \
            --namespace spillway-system \
            --set image.tag=test \
            --set metrics.serviceMonitor.enabled=false > /tmp/spillway-render.yaml
          test -s /tmp/spillway-render.yaml

      - name: Helm install dry-run
        run: |
          helm install spillway charts/spillway \
            --namespace spillway-system \
            --create-namespace \
            --set image.tag=test \
            --dry-run --debug > /tmp/spillway-install-dry-run.txt
          test -s /tmp/spillway-install-dry-run.txt
